## 实施计划概览

本计划将现有的单域名监控系统升级为支持子域名自动发现、智能证书关联和层级展示的完整解决方案。

***

## 一、数据库模型重构

### 1.1 新增 `DomainAsset` 表（域名资产表）

```go
type DomainAsset struct {
    global.GVA_MODEL
    Domain         string     `gorm:"column:domain;index:idx_domain"`
    ParentID       *uint      `gorm:"column:parent_id;comment:父域名ID"`
    RootDomain     string     `gorm:"column:root_domain;comment:根域名"`
    Category       string     `gorm:"column:category;comment:项目分类"`
    IsIgnored      bool       `gorm:"column:is_ignored;default:false"`
    CertID         *uint      `gorm:"column:cert_id;comment:关联证书ID"`
    CertType       string     `gorm:"column:cert_type;comment:证书类型(wildcard/single)"`
    DomainStatus   int        `gorm:"column:domain_status;default:1"`
    CertStatus     int        `gorm:"column:cert_status;default:1"`
    LastProbedAt   *time.Time `gorm:"column:last_probed_at"`
}
```

### 1.2 新增 `CertificateEntity` 表（证书实体表）

```go
type CertificateEntity struct {
    global.GVA_MODEL
    Fingerprint    string     `gorm:"column:fingerprint;uniqueIndex:idx_fingerprint;size:64"`
    Brand          string
    StartAt        *time.Time
    ExpireAt       *time.Time
    DaysRemaining  int
    TlsVersion     string
    IsWildcard     bool       `gorm:"column:is_wildcard;default:false"`
    SANs           string     `gorm:"column:sans;type:text;comment:Subject Alternative Names"`
}
```

### 1.3 修改 `CertCertificate` 表

* 保留现有字段用于向后兼容

* 新增 `CertID` 外键关联 `CertificateEntity`

* 新增 `ParentID` 支持树形结构

***

## 二、后端逻辑增强

### 2.1 证书探测增强 (`cert_probe.go`)

* **证书指纹提取**：使用 `crypto/sha256` 计算证书指纹

* **SAN 解析**：使用 `crypto/x509` 解析 `DNSNames` 和 `IPAddresses`

* **泛域名判定**：检查 SAN 中是否包含 `*.example.com` 格式

* **SNI 支持**：在 `tls.Dial` 时设置 `ServerName` 参数

### 2.2 子域名发现服务 (`subdomain_discovery.go`)

* **CT Log 集成**：调用 `crt.sh` API 获取已颁发证书的子域名

* **Passive DNS**：通过 DNS 记录枚举子域名

* **自动入库**：发现的新域名自动创建 `DomainAsset` 记录

* **并发控制**：使用 `semaphore` 限制并发探测数量（默认 10）

### 2.3 证书关联逻辑 (`cert_association.go`)

* **指纹去重**：相同指纹的域名关联到同一个 `CertificateEntity`

* **泛域名匹配**：泛域名证书自动关联所有匹配的子域名

* **优先级判定**：同时存在泛域名和独立证书时，选择剩余天数最短的

### 2.4 配置管理

* 新增 `AutoDiscovery` 配置项（布尔值）

* 新增 `MaxConcurrentProbes` 配置项（默认 10）

***

## 三、前端展示优化

### 3.1 树形表格改造 (`certCertificate.vue`)

* 使用 `el-table` 的 `tree-props` 属性实现层级展示

* 根域名作为父节点，子域名可展开/折叠

* 行内增加"证书类型"标签（泛域名/独立证书）

### 3.2 批量操作增强

* **按根域名重新探测**：选中父节点时，递归探测所有子域名

* **手动忽略**：支持批量标记子域名为"已忽略"

* **批量修改项目**：支持批量修改根域名及其子域名的项目归属

### 3.3 可视化统计

* 在仪表盘新增 ECharts 饼图

* 展示"根域名证书覆盖分布"

* 数据格式：`[{name: '泛域名证书', value: 20}, {name: '独立证书', value: 5}]`

### 3.4 筛选器逻辑迭代

* 子域名默认继承根域名的项目归属

* 父节点显示汇总状态（任一子域名异常则显示异常）

* 支持按证书类型筛选（泛域名/独立证书）

***

## 四、API 接口新增

### 4.1 子域名发现相关

* `POST /certCertificate/discoverSubdomains` - 手动触发子域名发现

* `GET /certCertificate/getSubdomainTree` - 获取树形结构的域名列表

### 4.2 批量操作相关

* `POST /certCertificate/batchReprobe` - 批量重新探测

* `POST /certCertificate/batchIgnore` - 批量忽略子域名

### 4.3 统计相关

* `GET /certCertificate/getStatistics` - 获取证书分布统计

***

## 五、实施顺序

1. **数据库迁移**：创建新表并迁移现有数据
2. **后端核心逻辑**：实现证书指纹提取、SAN 解析、子域名发现
3. **证书关联服务**：实现智能匹配和去重逻辑
4. **API 层开发**：新增接口并添加 Swagger 文档
5. **前端树形表格**：改造现有表格支持层级展示
6. **可视化统计**：集成 ECharts 饼图
7. **并发优化**：实现 semaphore 限流机制
8. **测试验证**：单元测试 + 集成测试

***

## 六、技术要点

* **Go 标准库**：使用 `crypto/x509` 深入解析 SAN

* **并发安全**：使用 `golang.org/x/sync/semaphore` 控制并发

* **SNI 正确性**：TLS 握手时必须设置 `ServerName`

* **证书重叠预警**：优先监控剩余天数最短的证书

* **零成本发现**：优先使用 CT Log API 而非暴力扫描

